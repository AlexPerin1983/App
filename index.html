<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposta de Películas 3.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: #f3f4f6;
            color: #374151;
        }
        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            color: #1f2937;
        }
        .cover-page {
            text-align: center;
            padding: 80px 20px;
            background: linear-gradient(45deg, #3b82f6, #9333ea);
            color: #ffffff;
        }
        .cover-page h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        .cover-page p {
            font-size: 18px;
            margin-bottom: 40px;
        }
        .section-title {
            background-color: #e11d48;
            color: white;
            padding: 10px;
            margin-bottom: 20px;
            text-align: left;
            font-size: 18px;
            font-weight: bold;
        }
        .content-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .content-table th, .content-table td {
            border: 1px solid #d1d5db;
            padding: 10px;
            text-align: left;
        }
        .content-table th {
            background-color: #6366f1;
            color: white;
        }
        .footer {
            text-align: center;
            font-size: 12px;
            margin-top: 40px;
            color: #6b7280;
        }
    </style>
</head>
<body>

<script>
    function generatePDF_v3_1() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20;

        const colors = {
            primary: [225, 29, 72], // Red-600
            secondary: [99, 102, 241], // Indigo-600
            accent: [236, 72, 153], // Pink-500
            text: [31, 41, 55], // Gray-800
            lightGray: [248, 249, 250] // Gray-50
        };

        function addCover() {
            doc.setFillColor(...colors.primary);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(36);
            doc.setFont("Montserrat", 'bold');
            doc.text("Proposta de Orçamento", margin, 60);

            doc.setFontSize(20);
            doc.text("Soluções em Películas de Alta Qualidade", margin, 90);

            doc.setFontSize(14);
            doc.setFont("Roboto", 'normal');
            doc.text("Cliente: Nome do Cliente", margin, 130);
            doc.text("Contato: (XX) XXXXX-XXXX", margin, 140);

            doc.setFontSize(12);
            doc.text("Desenvolvido por FUME JP", margin, pageHeight - 30);
        }

        function addFooter() {
            const footerHeight = 10;
            const footerY = pageHeight - footerHeight;

            doc.setFillColor(...colors.secondary);
            doc.rect(0, footerY, pageWidth, footerHeight, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont("Roboto", 'normal');
            doc.text("FUME JP | Soluções em Películas | www.fumejp.com.br", margin, footerY + 7);
            doc.text(`Página ${doc.internal.getNumberOfPages()}`, pageWidth - margin, footerY + 7, { align: 'right' });
        }

        function addPage() {
            doc.addPage();
            addFooter();
            return margin + 20;
        }

        function addSectionTitle(title) {
            let y = margin;
            if (y > pageHeight - 40) y = addPage();
            doc.setFillColor(...colors.accent);
            doc.rect(0, y, pageWidth, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont("Montserrat", 'bold');
            doc.text(title, margin, y + 7);
            y += 15;
            return y;
        }

        function addTableHeader(y) {
            const headers = ["Item", "Dimensões", "Película", "Ambiente", "Tipo", "Área", "Preço"];
            const colWidths = [10, 30, 45, 30, 30, 25, 30];
            let xOffset = margin;

            doc.setFillColor(...colors.secondary);
            doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont("Montserrat", 'bold');

            headers.forEach((header, index) => {
                doc.text(header, xOffset + 2, y + 7);
                xOffset += colWidths[index];
            });

            return y + 12;
        }

        function addTableRow(item, dims, film, env, type, area, price, y, index) {
            const rowHeight = 8;
            const isEvenRow = index % 2 === 0;
            const colWidths = [10, 30, 45, 30, 30, 25, 30];
            let xOffset = margin;

            if (isEvenRow) {
                doc.setFillColor(...colors.lightGray);
                doc.rect(margin, y - 3, pageWidth - margin * 2, rowHeight, 'F');
            }

            doc.setTextColor(...colors.text);
            doc.setFontSize(10);
            doc.setFont("Roboto", 'normal');

            const rowData = [item, dims, film, env, type, area, price];
            rowData.forEach((data, index) => {
                doc.text(data.toString(), xOffset + 2, y);
                xOffset += colWidths[index];
            });

            return y + 10;
        }

        function addTotalSection(totalArea, totalPrice, y) {
            if (y > pageHeight - 30) y = addPage();

            doc.setFillColor(...colors.secondary);
            doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont("Montserrat", 'bold');

            doc.text(`Área Total: ${totalArea.toFixed(2)} m²`, margin + 5, y + 7);
            doc.text(`Preço Total: R$ ${totalPrice.toFixed(2)}`, pageWidth - margin - 5, y + 7, { align: 'right' });

            return y + 20;
        }

        function addContent() {
            let y = addPage();

            function addOrcamentoSection(peliculaNome, medidas, index) {
                if (index > 0) y = addPage();
                y = addSectionTitle(`Orçamento para: ${peliculaNome}`);
                y = addTableHeader(y);
                medidas.forEach((medida, idx) => {
                    const largura = medida.querySelector('.largura-input').value || '0';
                    const altura = medida.querySelector('.altura-input').value || '0';
                    const quantidade = medida.querySelector('.quantidade-input').value || '0';
                    const totalM2 = medida.querySelector('input[placeholder="M²"]').value || '0';
                    const ambiente = medida.querySelector('.additional-fields select:first-child').value || '';
                    const tipoAplicacao = medida.querySelector('.additional-fields select:last-child').value || '';
                    const peliculaNome = medida.querySelector('.pelicula-select').value || '';
                    const pelicula = peliculas.find(p => p.nome === peliculaNome);
                    const preco = pelicula ? (pelicula.preco * parseFloat(totalM2)).toFixed(2) : '0.00';

                    y = addTableRow(idx + 1, `${largura}x${altura} (${quantidade})`, peliculaNome, ambiente, tipoAplicacao, `${totalM2} m²`, `R$ ${preco}`, y, idx);
                });

                const totalM2 = medidas.reduce((sum, group) => sum + (parseFloat(group.querySelector('input[placeholder="M²"]').value) || 0), 0);
                const precoTotal = medidas.reduce((sum, group) => {
                    const area = parseFloat(group.querySelector('input[placeholder="M²"]').value) || 0;
                    const pelicula = peliculas.find(p => p.nome === peliculaNome);
                    return sum + (pelicula ? area * pelicula.preco : 0);
                }, 0);

                y = addTotalSection(totalM2, precoTotal, y);
            }

            const medidaGroups = document.querySelectorAll('#medidasContainer > div');
            const medidasPorPelicula = {};

            medidaGroups.forEach(group => {
                const peliculaNome = group.querySelector('.pelicula-select').value || 'Sem Película';
                if (!medidasPorPelicula[peliculaNome]) {
                    medidasPorPelicula[peliculaNome] = [];
                }
                medidasPorPelicula[peliculaNome].push(group);
            });

            Object.entries(medidasPorPelicula).forEach(([peliculaNome, medidas], index) => {
                addOrcamentoSection(peliculaNome, medidas, index);
            });

            y = addPage();
            y = addSectionTitle("Total Geral do Orçamento");
            const totalGeralM2 = Object.values(medidasPorPelicula).flat().reduce((sum, group) => sum + (parseFloat(group.querySelector('input[placeholder="M²"]').value) || 0), 0);
            const precoGeralTotal = Object.values(medidasPorPelicula).flat().reduce((sum, group) => {
                const area = parseFloat(group.querySelector('input[placeholder="M²"]').value) || 0);
                const pelicula = peliculas.find(p => p.nome === group.querySelector('.pelicula-select').value);
                return sum + (pelicula ? area * pelicula.preco : 0);
            }, 0);

            addTotalSection(totalGeralM2, precoGeralTotal, y);
        }

        addCover();
        addContent();

        doc.save(`orcamento_${cliente.nome.replace(/\s+/g, '_').toLowerCase()}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', function () {
        generatePDF_v3_1();
    });
</script>

</body>
</html>
