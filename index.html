<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Insulfilm Otimizada Avançada</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; box-sizing: border-box; }
        input, button { width: 100%; margin: 5px 0; padding: 10px; box-sizing: border-box; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        #resultado, #layoutVisual { margin-top: 20px; }
        canvas { border: 1px solid #ddd; width: 100%; }
    </style>
</head>
<body>
    <h1>Calculadora de Insulfilm Otimizada Avançada</h1>
    <div>
        <input type="number" id="larguraPeca" step="0.01" placeholder="Largura da Peça (m)">
        <input type="number" id="alturaPeca" step="0.01" placeholder="Altura da Peça (m)">
        <input type="number" id="quantidadePeca" value="1" min="1" placeholder="Quantidade">
        <button onclick="adicionarPeca()">Adicionar Peça</button>
    </div>
    <button onclick="calcularOtimizacao()">Calcular Otimização</button>
    <div id="resultado"></div>
    <div id="layoutVisual">
        <h2>Layout Visual</h2>
        <canvas id="layoutCanvas"></canvas>
    </div>

    <script>
        let pecas = [];
        const LARGURA_BOBINA = 1.52;

        function adicionarPeca() {
            let largura = parseFloat(document.getElementById('larguraPeca').value);
            let altura = parseFloat(document.getElementById('alturaPeca').value);
            let quantidade = parseInt(document.getElementById('quantidadePeca').value);

            if (largura && altura && quantidade) {
                pecas.push({ largura, altura, quantidade });
                atualizarListaPecas();
                limparCamposPeca();
            } else {
                alert('Por favor, insira valores válidos para largura, altura e quantidade.');
            }
        }

        function calcularOtimizacao() {
            if (pecas.length === 0) {
                alert('Por favor, adicione pelo menos uma peça antes de calcular.');
                return;
            }

            let layout = otimizarCortes([...pecas]);
            desenharLayout(layout);
        }

        function otimizarCortes(pecasRestantes) {
            let layout = [];
            let espacosVazios = [{ x: 0, y: 0, largura: LARGURA_BOBINA, altura: Infinity }];

            pecasRestantes.sort((a, b) => (b.largura * b.altura) - (a.largura * a.altura));

            for (let peca of pecasRestantes) {
                let melhorEncaixe = null;
                let melhorEspacoIndex = -1;

                for (let i = 0; i < espacosVazios.length; i++) {
                    let espaco = espacosVazios[i];
                    if (encaixaPeca(peca, espaco)) {
                        if (!melhorEncaixe || espaco.y < melhorEncaixe.y || (espaco.y === melhorEncaixe.y && espaco.x < melhorEncaixe.x)) {
                            melhorEncaixe = espaco;
                            melhorEspacoIndex = i;
                        }
                    }
                }

                if (melhorEncaixe) {
                    layout.push({
                        x: melhorEncaixe.x,
                        y: melhorEncaixe.y,
                        largura: peca.largura,
                        altura: peca.altura
                    });

                    atualizarEspacosVazios(espacosVazios, melhorEspacoIndex, peca);
                }
            }

            return layout;
        }

        function encaixaPeca(peca, espaco) {
            return (peca.largura <= espaco.largura && peca.altura <= espaco.altura) ||
                   (peca.altura <= espaco.largura && peca.largura <= espaco.altura);
        }

        function atualizarEspacosVazios(espacosVazios, index, peca) {
            let espaco = espacosVazios[index];
            espacosVazios.splice(index, 1);

            if (peca.altura < espaco.altura) {
                espacosVazios.push({
                    x: espaco.x,
                    y: espaco.y + peca.altura,
                    largura: espaco.largura,
                    altura: espaco.altura - peca.altura
                });
            }

            if (peca.largura < espaco.largura) {
                espacosVazios.push({
                    x: espaco.x + peca.largura,
                    y: espaco.y,
                    largura: espaco.largura - peca.largura,
                    altura: peca.altura
                });
            }

            espacosVazios.sort((a, b) => a.y - b.y || a.x - b.x);
        }

        function desenharLayout(layout) {
            const canvas = document.getElementById('layoutCanvas');
            const ctx = canvas.getContext('2d');
            const deviceWidth = window.innerWidth - 20;
            canvas.width = deviceWidth;
            
            let alturaMaxima = Math.max(...layout.map(p => p.y + p.altura));
            canvas.height = Math.min(deviceWidth * 1.5, alturaMaxima * (deviceWidth / LARGURA_BOBINA));

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const escalaHorizontal = deviceWidth / LARGURA_BOBINA;
            const escalaVertical = canvas.height / alturaMaxima;

            layout.forEach((peca, index) => {
                ctx.fillStyle = getRandomColor();
                let x = peca.x * escalaHorizontal;
                let y = peca.y * escalaVertical;
                let largura = peca.largura * escalaHorizontal;
                let altura = peca.altura * escalaVertical;
                ctx.fillRect(x, y, largura, altura);
                
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.fillText(`${peca.largura.toFixed(2)}x${peca.altura.toFixed(2)}`, x + 5, y + 20);
            });

            ctx.fillStyle = 'black';
            ctx.font = '14px Arial';
            ctx.fillText(`Comprimento total: ${alturaMaxima.toFixed(2)}m`, 10, canvas.height - 10);
        }

        function getRandomColor() {
            return `hsl(${Math.random() * 360}, 70%, 80%)`;
        }

        function atualizarListaPecas() {
            let lista = '<h2>Peças Adicionadas:</h2>';
            pecas.forEach((peca, index) => {
                lista += `<p>Peça ${index + 1}: ${peca.largura.toFixed(2)}m x ${peca.altura.toFixed(2)}m - ${peca.quantidade} unidades</p>`;
            });
            document.getElementById('resultado').innerHTML = lista;
        }

        function limparCamposPeca() {
            document.getElementById('larguraPeca').value = '';
            document.getElementById('alturaPeca').value = '';
            document.getElementById('quantidadePeca').value = '1';
        }

        window.addEventListener('resize', () => {
            if (pecas.length > 0) {
                calcularOtimizacao();
            }
        });
    </script>
</body>
</html>
